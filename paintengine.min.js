"use strict";class PaintEngine{constructor(t){if(this.user=t,!this.user.sketch_canvas)throw"PaintEngine::constructor(): <sketch_canvas> must be defined";if(!this.user.sketch_files)throw"PaintEngine::constructor(): <sketch_files> must be defined";if(!this.user.sketch_files.length)throw"PaintEngine::constructor(): <sketch_files> must be have at least 1 element";if(this.max_sketchs=this.user.sketch_files.length-1,this.cur_sketch=0,this.user.color||(this.user.color={r:128,g:0,b:128,a:255}),this.user.color_blacklist||(this.user.color_blacklist=[{r:0,g:0,b:0,a:255}]),this.user.color_transparency||(this.user.color_transparency=[{r:255,g:255,b:255,a:255}]),this.user.sticker_canvas&&this.user.current_sticker_canvas){var s=document.getElementById(this.user.current_sticker_canvas),e=document.getElementById(this.user.sticker_canvas);this.sticker_scale_x=s.width/(e.width/this.user.sticker_x),this.sticker_scale_y=s.height/(e.height/this.user.sticker_y)}this.history_a=[],this.history_ptr=0,this.tool=null}set color(t){this.user.color=t}run(){document.getElementById(this.user.sketch_canvas).onclick=function(t){this.tool(t)}.bind(this),this.user.prev_btn_id&&(document.getElementById(this.user.prev_btn_id).onclick=function(){this.load_sketch(-1)}.bind(this)),this.user.next_btn_id&&(document.getElementById(this.user.next_btn_id).onclick=function(){this.load_sketch(1)}.bind(this)),this.user.reload_btn_id&&(document.getElementById(this.user.reload_btn_id).onclick=function(){this.load_sketch(0)}.bind(this)),this.user.undo_btn_id&&(document.getElementById(this.user.undo_btn_id).onclick=function(){this.back_history()}.bind(this)),this.user.redo_btn_id&&(document.getElementById(this.user.redo_btn_id).onclick=function(){this.redo_history()}.bind(this)),this.user.paint_btn_id&&(document.getElementById(this.user.paint_btn_id).onclick=function(){this.paint()}.bind(this)),this.user.erase_btn_id&&(document.getElementById(this.user.erase_btn_id).onclick=function(){this.erase()}.bind(this)),this.user.eyedrop_btn_id&&(document.getElementById(this.user.eyedrop_btn_id).onclick=function(){this.eyedrop()}.bind(this)),this.user.sticker_btn_id&&(document.getElementById(this.user.sticker_btn_id).onclick=function(){this.sticker()}.bind(this)),this.load_sketch(0),this.paint_color=this.user.color,this.paint()}load_sketch(t){var s=document.getElementById(this.user.sketch_canvas),e=s.getContext("2d"),i=new Image;i.onload=function(){e.imageSmoothingEnabled=!1,e.drawImage(i,0,0,s.width,s.height)},this.cur_sketch+=t,this.cur_sketch=this.cur_sketch<0?this.max_sketchs:this.cur_sketch>this.max_sketchs?0:this.cur_sketch,i.src=this.user.sketch_files[this.cur_sketch],this.history_a.length=0}back_history(){this.history_a.length&&this.history_ptr>0&&(this.history_a.length==this.history_ptr&&(this.history_a[this.history_ptr]=document.getElementById(this.user.sketch_canvas).toDataURL("image/png")),this.history_ptr--,this._canvas_history_update())}redo_history(){this.history_a.length&&this.history_ptr<this.history_a.length&&(this.history_ptr++,this._canvas_history_update())}_canvas_history_update(){var t=document.getElementById(this.user.sketch_canvas).getContext("2d"),s=new Image;s.onload=function(){t.imageSmoothingEnabled=!1,t.drawImage(s,0,0)},s.src=this.history_a[this.history_ptr]}_save_history(){this.history_a[this.history_ptr]=document.getElementById(this.user.sketch_canvas).toDataURL("image/png"),this.history_a.length=++this.history_ptr}_show_current_color(){if(this.user.current_color_canvas){var t=document.getElementById(this.user.current_color_canvas),s=t.getContext("2d");s.fillStyle="rgba("+this.user.color.r+","+this.user.color.g+","+this.user.color.b+","+this.user.color.a+")",s.fillRect(0,0,t.width,t.height)}}_show_border(t){this.user.css_class_border&&(this.user.erase_btn_id&&document.getElementById(this.user.erase_btn_id).classList.remove(this.user.css_class_border),this.user.paint_btn_id&&document.getElementById(this.user.paint_btn_id).classList.remove(this.user.css_class_border),this.user.eyedrop_btn_id&&document.getElementById(this.user.eyedrop_btn_id).classList.remove(this.user.css_class_border),this.user.sticker_btn_id&&document.getElementById(this.user.sticker_btn_id).classList.remove(this.user.css_class_border),t&&document.getElementById(t).classList.add(this.user.css_class_border))}erase(){this._show_border(this.user.erase_btn_id),this.tool=this.bucket_tool,this.user.color={r:255,g:255,b:255,a:255},this._show_current_color()}eyedrop(){this._show_border(this.user.eyedrop_btn_id),this.tool=this.eyedropper_tool}eyedropper_tool(t){this._get_color_xy(this.user.sketch_canvas,t)}_get_color_xy(t,s){var e=document.getElementById(t).getContext("2d").getImageData(s.offsetX,s.offsetY,1,1),i={r:e.data[0],g:e.data[1],b:e.data[2],a:e.data[3]};this._check_color_in_list(i,this.user.color_blacklist)||(this.paint_color=this.user.color=i,this.paint())}_check_color_in_list(t,s){for(var e=0;e<s.length;e++)if(t.r===s[e].r&&t.g===s[e].g&&t.b===s[e].b)return!0;return!1}paint(){if(this._show_border(this.user.paint_btn_id),this.tool=this.bucket_tool,this.user.color=this.paint_color,this._show_current_color(),this.user.palette_canvas&&this.user.palette_file){var t=document.getElementById(this.user.palette_canvas),s=t.getContext("2d"),e=new Image;e.onload=function(){s.imageSmoothingEnabled=!1,s.drawImage(e,0,0,t.width,t.height)},e.src=this.user.palette_file,document.getElementById(this.user.palette_canvas).onclick=function(t){this.color_picker(t)}.bind(this)}}color_picker(t){this._get_color_xy(this.user.palette_canvas,t)}bucket_tool(t){var s=document.getElementById(this.user.sketch_canvas),e=s.getContext("2d"),i=[{x:t.offsetX,y:t.offsetY}],r=e.getImageData(0,0,s.width,s.height),h=4*(t.offsetY*s.width+t.offsetX),c={r:r.data[h],g:r.data[h+1],b:r.data[h+2],a:r.data[h+3]},o=[...this.user.color_blacklist,this.user.color];if(!this._check_color_in_list(c,o)){var a=function(t){return r.data[h+0+t]==c.r&&r.data[h+1+t]==c.g&&r.data[h+2+t]==c.b&&r.data[h+3+t]==c.a};for(this._save_history();i.length>0;){var _=i.pop(),n=_.x,d=_.y;for(h=4*(d*s.width+n);d-- >=0&&a(0);)h-=4*s.width;h+=4*s.width,d++;for(var l=!1,u=!1;d++<s.height&&a(0);)r.data[h]=this.user.color.r,r.data[h+1]=this.user.color.g,r.data[h+2]=this.user.color.b,r.data[h+3]=this.user.color.a,n>0&&(a(-4)?l||(i.push({x:n-1,y:d}),l=!0):l&&(l=!1)),n<s.width-1&&(a(4)?u||(i.push({x:n+1,y:d}),u=!0):u&&(u=!1)),h+=4*s.width}e.putImageData(r,0,0)}}sticker(){if(this.user.sticker_canvas&&this.user.sticker_file&&this.user.sticker_x&&this.user.sticker_y){this._show_border(this.user.sticker_btn_id),this.tool=this.sticker_tool,this._show_sticker();var t=document.getElementById(this.user.sticker_canvas),s=t.getContext("2d");s.fillStyle="white",s.fillRect(0,0,t.width,t.height);var e=new Image;e.onload=function(){s.imageSmoothingEnabled=!1,s.drawImage(e,0,0,t.width,t.height)},e.src=this.user.sticker_file,this.sticker_size_x=t.width/this.user.sticker_x,this.sticker_size_y=t.height/this.user.sticker_y,document.getElementById(this.user.sticker_canvas).onclick=function(t){this.sticker_picker(t)}.bind(this)}}sticker_tool(t){if(this.temp_sticker_canvas){var s=document.getElementById(this.user.sketch_canvas),e=s.getContext("2d"),i=e.getImageData(0,0,s.width,s.height),r={r:i.data[4*(t.offsetY*s.width+t.offsetX)],g:i.data[4*(t.offsetY*s.width+t.offsetX)+1],b:i.data[4*(t.offsetY*s.width+t.offsetX)+2],a:i.data[4*(t.offsetY*s.width+t.offsetX)+3]};this._check_color_in_list(r,this.user.color_blacklist)||(this._save_history(),e.imageSmoothingEnabled=!1,e.drawImage(this.temp_sticker_canvas,t.offsetX-this.sticker_size_x/2,t.offsetY-this.sticker_size_y/2))}}_show_sticker(){if(this.user.current_sticker_canvas){var t=document.getElementById(this.user.current_sticker_canvas),s=t.getContext("2d");s.fillStyle="white",s.fillRect(0,0,t.width,t.height),this.temp_sticker_canvas&&(s.save(),1!=this.sticker_scale_x&&1!=this.sticker_scale_y&&s.scale(this.sticker_scale_x,this.sticker_scale_y),s.imageSmoothingEnabled=!1,s.drawImage(this.temp_sticker_canvas,0,0),s.restore())}}sticker_picker(t){var s=Math.floor(t.offsetX/this.sticker_size_x)*this.sticker_size_x,e=Math.floor(t.offsetY/this.sticker_size_y)*this.sticker_size_y,i=document.getElementById(this.user.sticker_canvas).getContext("2d").getImageData(s,e,this.sticker_size_x,this.sticker_size_y);this.temp_sticker_canvas=document.createElement("canvas"),this.temp_sticker_canvas.width=i.width,this.temp_sticker_canvas.height=i.height;for(var r=i.data,h=0;h<r.length;h+=4){var c={r:r[h+0],g:r[h+1],b:r[h+2],a:r[h+3]};this._check_color_in_list(c,this.user.color_transparency)&&(r[h+3]=0)}this.temp_sticker_canvas.getContext("2d").putImageData(i,0,0),this.sticker()}}